<!DOCTYPE html>

<html lang="en" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Extensions Example &#8212; Apache DataFusion Ballista  documentation</title>
    
    <link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
  
    
    <link rel="stylesheet"
      href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
    <link rel="preload" as="font" type="font/woff2" crossorigin
      href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
    <link rel="preload" as="font" type="font/woff2" crossorigin
      href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">
  
    
      
  
    
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/pydata-sphinx-theme.css?v=1140d252" />
    <link rel="stylesheet" type="text/css" href="../_static/theme_overrides.css?v=ef9fea58" />
    
    <link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">
  
    <script src="../_static/documentation_options.js?v=8a448e45"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Ballista Architecture" href="../contributors-guide/architecture.html" />
    <link rel="prev" title="Extending Ballista Scheduler And Executors" href="extending-components.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    


    <div class="container-xl">
      <div class="row">
          
            
            <!-- Only show if we have sidebars configured, else just a small margin  -->
            <div class="col-12 col-md-3 bd-sidebar">
              <div class="sidebar-start-items">
<a class="navbar-brand" href="../index.html">
  <img src="../_static/images/ballista-logo.png" class="logo" alt="logo">
</a>

<form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form>

<nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    
    <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  User Guide
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="introduction.html">
   Introduction
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Cluster Deployment
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="deployment/index.html">
   Deployment
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="deployment/quick-start.html">
     Quick Start
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="deployment/cargo-install.html">
     Cargo Install
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="deployment/docker.html">
     Docker
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="deployment/docker-compose.html">
     Docker Compose
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="deployment/kubernetes.html">
     Kubernetes
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="scheduler.html">
   Scheduler
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Clients
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="python.html">
   Python
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="rust.html">
   Rust
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="cli.html">
   SQL CLI
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Reference
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="configs.html">
   Configuration
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="tuning-guide.html">
   Tuning Guide
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="metrics.html">
   Ballista Scheduler Metrics
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="faq.html">
   Frequently Asked Questions
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="extending-components.html">
   Extending Ballista Scheduler And Executors
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Extensions Example
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Contributors Guide
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../contributors-guide/architecture.html">
   Ballista Architecture
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../contributors-guide/code-organization.html">
   Ballista Code Organization
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../contributors-guide/development.html">
   Ballista Development
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference external" href="https://github.com/apache/datafusion-ballista/">
   Source code
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Community
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../community/communication.html">
   Communication
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference external" href="https://github.com/apache/datafusion-ballista/issues">
   Issue tracker
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference external" href="https://github.com/apache/datafusion-ballista/blob/main/CODE_OF_CONDUCT.md">
   Code of conduct
  </a>
 </li>
</ul>

    
  </div>
</nav>
              </div>
              <div class="sidebar-end-items">
              </div>
            </div>
            
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
            
              
              <div class="toc-item">
                
<div class="tocsection onthispage pt-5 pb-3">
    <i class="fas fa-list"></i> On this page
</div>

<nav id="bd-toc-nav">
    <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#logical-plan-extension">
   Logical Plan Extension
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#dataframe-extension">
   DataFrame Extension
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#logical-extension-codec">
   Logical Extension Codec
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#logical-to-physical-plan-translation">
   Logical to Physical Plan Translation
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#conclusion">
   Conclusion
  </a>
 </li>
</ul>

</nav>
              </div>
              
              <div class="toc-item">
                

<div class="tocsection editthispage">
    <a href="https://github.com/apache/datafusion-ballista/edit/main/docs/source/user-guide/extensions-example.md">
        <i class="fas fa-pencil-alt"></i> Edit this page
    </a>
</div>

              </div>
              
            
          </div>
          

          
          
            
          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <!---
  Licensed to the Apache Software Foundation (ASF) under one
  or more contributor license agreements.  See the NOTICE file
  distributed with this work for additional information
  regarding copyright ownership.  The ASF licenses this file
  to you under the Apache License, Version 2.0 (the
  "License"); you may not use this file except in compliance
  with the License.  You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing,
  software distributed under the License is distributed on an
  "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
  KIND, either express or implied.  See the License for the
  specific language governing permissions and limitations
  under the License.
-->
<section id="extensions-example">
<h1>Extensions Example<a class="headerlink" href="#extensions-example" title="Link to this heading">¶</a></h1>
<p>This project demonstrates possible extensions mechanisms.</p>
<p>The goal of this small project is to enhance Ballista’s capabilities by providing new logical and physical operators,
utilities, and integration tools to support additional data processing workflows.</p>
<p>This example will implement <a class="reference external" href="https://spark.apache.org/docs/latest/api/python/reference/pyspark.sql/api/pyspark.sql.DataFrame.sample.html">
<code class="docutils literal notranslate"><span class="pre">sample()</span></code></a>
operator which will return a sampled subset of original <code class="docutils literal notranslate"><span class="pre">DataFrame</span></code>:</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="kd">let</span><span class="w"> </span><span class="n">ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SessionContext</span><span class="p">::</span><span class="n">remote_with_state</span><span class="p">(</span><span class="s">&quot;df://localhost:50050&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<span class="kd">let</span><span class="w"> </span><span class="n">df</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ctx</span><span class="p">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="s">&quot;data/&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">Default</span><span class="p">::</span><span class="n">default</span><span class="w"> </span><span class="p">()).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>

<span class="c1">// The `sample` operator, defined in this project,</span>
<span class="c1">// samples 30% of the data and displays the result.</span>
<span class="kd">let</span><span class="w"> </span><span class="n">df</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">df</span><span class="p">.</span><span class="n">sample</span><span class="p">(</span><span class="mf">0.30</span><span class="p">,</span><span class="w"> </span><span class="nb">None</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="p">;</span>
</pre></div>
</div>
<p>To implement this functionality, it is necessary to implement new logical plan extension, physical operators and extend
<code class="docutils literal notranslate"><span class="pre">DataFrame</span></code> to expose new operator.</p>
<blockquote>
<div><p>[!WARNING]<br />
Please do not use implemented sampling operator for production, statisticians would not approve it, probably.</p>
</div></blockquote>
<p>This demo will provide:</p>
<ul class="simple">
<li><p>Custom DataFusion (logical and physical) nodes.</p></li>
<li><p>Logical and physical extension codecs.</p></li>
<li><p>Custom protocol buffer definitions.</p></li>
<li><p>Extension query planner.</p></li>
</ul>
<section id="logical-plan-extension">
<h2>Logical Plan Extension<a class="headerlink" href="#logical-plan-extension" title="Link to this heading">¶</a></h2>
<p>The first step is to implement a custom logical plan extension:</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="sd">//! This module defines the implementation of the `UserDefinedLogicalNodeCore` trait for the `Sample` logical plan node.</span>
<span class="sd">//!</span>
<span class="sd">//! The `Sample` node represents a custom logical plan extension for sampling data within a query plan.</span>
<span class="sd">//!</span>
<span class="k">use</span><span class="w"> </span><span class="n">std</span><span class="p">::{</span><span class="n">hash</span><span class="p">::</span><span class="n">Hash</span><span class="p">,</span><span class="w"> </span><span class="n">vec</span><span class="p">};</span>

<span class="k">use</span><span class="w"> </span><span class="n">datafusion</span><span class="p">::{</span>
<span class="w">    </span><span class="n">error</span><span class="p">::</span><span class="n">DataFusionError</span><span class="p">,</span>
<span class="w">    </span><span class="n">logical_expr</span><span class="p">::{</span><span class="n">LogicalPlan</span><span class="p">,</span><span class="w"> </span><span class="n">UserDefinedLogicalNodeCore</span><span class="p">},</span>
<span class="p">};</span>

<span class="cp">#[derive(Debug, Clone, PartialEq, PartialOrd)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">Sample</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">fraction</span><span class="p">:</span><span class="w"> </span><span class="kt">f32</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">seed</span><span class="p">:</span><span class="w"> </span><span class="nb">Option</span><span class="o">&lt;</span><span class="kt">i64</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">input</span><span class="p">:</span><span class="w"> </span><span class="nc">LogicalPlan</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">impl</span><span class="w"> </span><span class="n">Hash</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Sample</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">hash</span><span class="o">&lt;</span><span class="n">H</span><span class="p">:</span><span class="w"> </span><span class="nc">std</span><span class="p">::</span><span class="n">hash</span><span class="p">::</span><span class="n">Hasher</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">H</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">seed</span><span class="p">.</span><span class="n">hash</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">input</span><span class="p">.</span><span class="n">hash</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">impl</span><span class="w"> </span><span class="nb">Eq</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Sample</span><span class="w"> </span><span class="p">{}</span>

<span class="k">impl</span><span class="w"> </span><span class="n">Sample</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">new</span><span class="p">(</span><span class="n">fraction</span><span class="p">:</span><span class="w"> </span><span class="kt">f32</span><span class="p">,</span><span class="w"> </span><span class="n">seed</span><span class="p">:</span><span class="w"> </span><span class="nb">Option</span><span class="o">&lt;</span><span class="kt">i64</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">input</span><span class="p">:</span><span class="w"> </span><span class="nc">LogicalPlan</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">Self</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="bp">Self</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">fraction</span><span class="p">,</span>
<span class="w">            </span><span class="n">seed</span><span class="p">,</span>
<span class="w">            </span><span class="n">input</span><span class="p">,</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">impl</span><span class="w"> </span><span class="n">UserDefinedLogicalNodeCore</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Sample</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">name</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kp">&amp;</span><span class="kt">str</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="s">&quot;Sample&quot;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">inputs</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nb">Vec</span><span class="o">&lt;&amp;</span><span class="n">LogicalPlan</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="fm">vec!</span><span class="p">[</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">.</span><span class="n">input</span><span class="p">]</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">schema</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">datafusion</span><span class="p">::</span><span class="n">common</span><span class="p">::</span><span class="n">DFSchemaRef</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">input</span><span class="p">.</span><span class="n">schema</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">expressions</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nb">Vec</span><span class="o">&lt;</span><span class="n">datafusion</span><span class="p">::</span><span class="n">prelude</span><span class="p">::</span><span class="n">Expr</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="fm">vec!</span><span class="p">[]</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">fmt_for_explain</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">f</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">std</span><span class="p">::</span><span class="n">fmt</span><span class="p">::</span><span class="n">Formatter</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">std</span><span class="p">::</span><span class="n">fmt</span><span class="p">::</span><span class="nb">Result</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">f</span><span class="p">.</span><span class="n">write_fmt</span><span class="p">(</span><span class="fm">format_args!</span><span class="p">(</span>
<span class="w">            </span><span class="s">&quot;Sample: fraction: {}, seed: {:?}&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="bp">self</span><span class="p">.</span><span class="n">fraction</span><span class="p">,</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">seed</span>
<span class="w">        </span><span class="p">))</span><span class="o">?</span><span class="p">;</span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">with_exprs_and_inputs</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span>
<span class="w">        </span><span class="n">_exprs</span><span class="p">:</span><span class="w"> </span><span class="nb">Vec</span><span class="o">&lt;</span><span class="n">datafusion</span><span class="p">::</span><span class="n">prelude</span><span class="p">::</span><span class="n">Expr</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">        </span><span class="n">inputs</span><span class="p">:</span><span class="w"> </span><span class="nb">Vec</span><span class="o">&lt;</span><span class="n">LogicalPlan</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">datafusion</span><span class="p">::</span><span class="n">error</span><span class="p">::</span><span class="nb">Result</span><span class="o">&lt;</span><span class="bp">Self</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="bp">Self</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">seed</span><span class="p">:</span><span class="w"> </span><span class="nc">self</span><span class="p">.</span><span class="n">seed</span><span class="p">,</span>
<span class="w">            </span><span class="n">fraction</span><span class="p">:</span><span class="w"> </span><span class="nc">self</span><span class="p">.</span><span class="n">fraction</span><span class="p">,</span>
<span class="w">            </span><span class="n">input</span><span class="p">:</span><span class="w"> </span><span class="nc">inputs</span>
<span class="w">                </span><span class="p">.</span><span class="n">first</span><span class="p">()</span>
<span class="w">                </span><span class="p">.</span><span class="n">ok_or</span><span class="p">(</span><span class="n">DataFusionError</span><span class="p">::</span><span class="n">Plan</span><span class="p">(</span><span class="s">&quot;expected single input&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">()))</span><span class="o">?</span>
<span class="w">                </span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span>
<span class="w">        </span><span class="p">})</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="dataframe-extension">
<h2>DataFrame Extension<a class="headerlink" href="#dataframe-extension" title="Link to this heading">¶</a></h2>
<p>To expose this functionality to end users, a DataFrame extension] is implemented. This extension creates a
<code class="docutils literal notranslate"><span class="pre">LogicalPlan::Extension(extension)</span></code> node:</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="k">use</span><span class="w"> </span><span class="n">std</span><span class="p">::</span><span class="n">sync</span><span class="p">::</span><span class="n">Arc</span><span class="p">;</span>

<span class="k">use</span><span class="w"> </span><span class="n">datafusion</span><span class="p">::{</span>
<span class="w">    </span><span class="n">error</span><span class="p">::</span><span class="n">DataFusionError</span><span class="p">,</span>
<span class="w">    </span><span class="n">logical_expr</span><span class="p">::{</span><span class="n">Extension</span><span class="p">,</span><span class="w"> </span><span class="n">LogicalPlan</span><span class="p">},</span>
<span class="w">    </span><span class="n">prelude</span><span class="p">::</span><span class="n">DataFrame</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">use</span><span class="w"> </span><span class="k">crate</span><span class="p">::</span><span class="n">logical</span><span class="p">::</span><span class="n">sample_extension</span><span class="p">::</span><span class="n">Sample</span><span class="p">;</span>

<span class="k">pub</span><span class="w"> </span><span class="k">trait</span><span class="w"> </span><span class="n">DataFrameExt</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">sample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">fraction</span><span class="p">:</span><span class="w"> </span><span class="kt">f32</span><span class="p">,</span><span class="w"> </span><span class="n">seed</span><span class="p">:</span><span class="w"> </span><span class="nb">Option</span><span class="o">&lt;</span><span class="kt">i64</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">datafusion</span><span class="p">::</span><span class="n">error</span><span class="p">::</span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">DataFrame</span><span class="o">&gt;</span><span class="p">;</span>
<span class="p">}</span>

<span class="sd">/// Returns a new `DataFrame` containing a random sample of rows from the original `DataFrame`.</span>
<span class="sd">///</span>
<span class="sd">/// # Arguments</span>
<span class="sd">///</span>
<span class="sd">/// * `fraction` - The fraction of rows to sample, must be in the range (0.0, 1.0].</span>
<span class="sd">/// * `seed` - An optional seed for the random number generator to ensure reproducibility.</span>
<span class="sd">///</span>
<span class="sd">/// # Errors</span>
<span class="sd">///</span>
<span class="sd">/// Returns a `DataFusionError::Configuration` if `fraction` is not within the valid range.</span>
<span class="sd">///</span>
<span class="k">impl</span><span class="w"> </span><span class="n">DataFrameExt</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">DataFrame</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">sample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">fraction</span><span class="p">:</span><span class="w"> </span><span class="kt">f32</span><span class="p">,</span><span class="w"> </span><span class="n">seed</span><span class="p">:</span><span class="w"> </span><span class="nb">Option</span><span class="o">&lt;</span><span class="kt">i64</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">datafusion</span><span class="p">::</span><span class="n">error</span><span class="p">::</span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">DataFrame</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="o">!</span><span class="p">(</span><span class="n">fraction</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0.0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">fraction</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mf">1.0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nb">Err</span><span class="p">(</span><span class="n">DataFusionError</span><span class="p">::</span><span class="n">Configuration</span><span class="p">(</span>
<span class="w">                </span><span class="s">&quot;fraction should be in 0 ..= 1 range&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span>
<span class="w">            </span><span class="p">))</span><span class="o">?</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">seed</span><span class="p">.</span><span class="n">unwrap_or</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nb">Err</span><span class="p">(</span><span class="n">DataFusionError</span><span class="p">::</span><span class="n">Configuration</span><span class="p">(</span>
<span class="w">                </span><span class="s">&quot;seed should be positive number&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span>
<span class="w">            </span><span class="p">))</span><span class="o">?</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">state</span><span class="p">,</span><span class="w"> </span><span class="n">input</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">into_parts</span><span class="p">();</span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">node</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Arc</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="n">Sample</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">fraction</span><span class="p">,</span>
<span class="w">            </span><span class="n">seed</span><span class="p">,</span>
<span class="w">            </span><span class="n">input</span><span class="p">,</span>
<span class="w">        </span><span class="p">});</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">extension</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Extension</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">node</span><span class="w"> </span><span class="p">};</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">plan</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LogicalPlan</span><span class="p">::</span><span class="n">Extension</span><span class="p">(</span><span class="n">extension</span><span class="p">);</span>

<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">DataFrame</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="n">state</span><span class="p">,</span><span class="w"> </span><span class="n">plan</span><span class="p">))</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This approach enables the addition of new methods to the DataFusion DataFrame implementation:</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="kd">let</span><span class="w"> </span><span class="n">ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SessionContext</span><span class="p">::</span><span class="n">remote_with_state</span><span class="p">(</span><span class="s">&quot;df://localhost:50050&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<span class="kd">let</span><span class="w"> </span><span class="n">df</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ctx</span><span class="p">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="s">&quot;data/&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">Default</span><span class="p">::</span><span class="n">default</span><span class="w"> </span><span class="p">()).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>

<span class="c1">// The DataFrame extension provides the `sample` method</span>
<span class="kd">let</span><span class="w"> </span><span class="n">df</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">df</span><span class="p">.</span><span class="n">sample</span><span class="p">(</span><span class="mf">0.30</span><span class="p">,</span><span class="w"> </span><span class="nb">None</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="p">;</span>
</pre></div>
</div>
<p><img alt="diagram" src="../_images/ballista_extensions.excalidraw.svg" /></p>
</section>
<section id="logical-extension-codec">
<h2>Logical Extension Codec<a class="headerlink" href="#logical-extension-codec" title="Link to this heading">¶</a></h2>
<p>With the extension in place, a custom logical extension codec is required to transmit the client logical plan to the
scheduler.</p>
<p>The logical extension codec typically consists of two components: Google Protocol Buffer definitions:</p>
<div class="highlight-proto notranslate"><div class="highlight"><pre><span></span><span class="k">syntax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;proto3&quot;</span><span class="p">;</span>

<span class="kn">package</span><span class="w"> </span><span class="nn">extension</span><span class="o">.</span><span class="n">ballista</span><span class="p">;</span>

<span class="c1">// used in building the codecs and compiled to Rust at build time.</span>
<span class="k">import</span><span class="w"> </span><span class="s">&quot;datafusion_common.proto&quot;</span><span class="p">;</span>
<span class="c1">//</span>
<span class="c1">// message naming convention</span>
<span class="c1">//</span>
<span class="c1">// prefix L means logical</span>
<span class="c1">// prefix P means physical</span>
<span class="c1">//</span>


<span class="c1">//</span>
<span class="c1">// Logical Plan Extensions</span>
<span class="c1">//</span>


<span class="c1">// this is the root message that captures all possible</span>
<span class="c1">// logical plan messages which can be sent across</span>
<span class="kd">message</span><span class="w"> </span><span class="nc">LMessage</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">oneof</span><span class="w"> </span><span class="n">Extension</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">LSample</span><span class="w"> </span><span class="na">sample</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>


<span class="kd">message</span><span class="w"> </span><span class="nc">LSample</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="na">fraction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="k">optional</span><span class="w"> </span><span class="kt">int64</span><span class="w"> </span><span class="na">seed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">//</span>
<span class="c1">// Physical Plan Extensions</span>
<span class="c1">//</span>


<span class="kd">message</span><span class="w"> </span><span class="nc">PMessage</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">oneof</span><span class="w"> </span><span class="n">Extension</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// opaque message means that extension codec does not handle</span>
<span class="w">        </span><span class="c1">// those values hence encoding/decoding is delegated to some other codec</span>
<span class="w">        </span><span class="c1">// (in this case default datafusion codec).</span>
<span class="w">        </span><span class="kt">bytes</span><span class="w"> </span><span class="na">opaque</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">        </span><span class="n">PSample</span><span class="w"> </span><span class="na">sample</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>

<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">message</span><span class="w"> </span><span class="nc">PSample</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="na">fraction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="k">optional</span><span class="w"> </span><span class="kt">int64</span><span class="w"> </span><span class="na">seed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">LogicalExtensionCodec</span></code> extends <code class="docutils literal notranslate"><span class="pre">BallistaLogicalExtensionCodec</span></code> handling newly defined operator messages:</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="cp">#[derive(Debug, Default)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">ExtendedBallistaLogicalCodec</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">inner</span><span class="p">:</span><span class="w"> </span><span class="nc">BallistaLogicalExtensionCodec</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">impl</span><span class="w"> </span><span class="n">LogicalExtensionCodec</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">ExtendedBallistaLogicalCodec</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">try_decode</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span>
<span class="w">        </span><span class="n">buf</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="p">[</span><span class="kt">u8</span><span class="p">],</span>
<span class="w">        </span><span class="n">inputs</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="p">[</span><span class="n">datafusion</span><span class="p">::</span><span class="n">logical_expr</span><span class="p">::</span><span class="n">LogicalPlan</span><span class="p">],</span>
<span class="w">        </span><span class="n">_ctx</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">datafusion</span><span class="p">::</span><span class="n">prelude</span><span class="p">::</span><span class="n">SessionContext</span><span class="p">,</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">datafusion</span><span class="p">::</span><span class="n">error</span><span class="p">::</span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">datafusion</span><span class="p">::</span><span class="n">logical_expr</span><span class="p">::</span><span class="n">Extension</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="o">=</span>
<span class="w">            </span><span class="n">LMessage</span><span class="p">::</span><span class="n">decode</span><span class="p">(</span><span class="n">buf</span><span class="p">).</span><span class="n">map_err</span><span class="p">(</span><span class="o">|</span><span class="n">e</span><span class="o">|</span><span class="w"> </span><span class="n">DataFusionError</span><span class="p">::</span><span class="n">Internal</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">to_string</span><span class="p">()))</span><span class="o">?</span><span class="p">;</span>

<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">message</span><span class="p">.</span><span class="n">extension</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nb">Some</span><span class="p">(</span><span class="n">Extension</span><span class="p">::</span><span class="n">Sample</span><span class="p">(</span><span class="n">sample</span><span class="p">))</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="kd">let</span><span class="w"> </span><span class="n">node</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Arc</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="n">Sample</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">input</span><span class="p">:</span><span class="w"> </span><span class="nc">inputs</span>
<span class="w">                        </span><span class="p">.</span><span class="n">first</span><span class="p">()</span>
<span class="w">                        </span><span class="p">.</span><span class="n">ok_or</span><span class="p">(</span><span class="n">DataFusionError</span><span class="p">::</span><span class="n">Plan</span><span class="p">(</span><span class="s">&quot;expected input&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">()))</span><span class="o">?</span>
<span class="w">                        </span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span>
<span class="w">                    </span><span class="n">seed</span><span class="p">:</span><span class="w"> </span><span class="nc">sample</span><span class="p">.</span><span class="n">seed</span><span class="p">,</span>
<span class="w">                    </span><span class="n">fraction</span><span class="p">:</span><span class="w"> </span><span class="nc">sample</span><span class="p">.</span><span class="n">fraction</span><span class="p">,</span>
<span class="w">                </span><span class="p">});</span>

<span class="w">                </span><span class="nb">Ok</span><span class="p">(</span><span class="n">datafusion</span><span class="p">::</span><span class="n">logical_expr</span><span class="p">::</span><span class="n">Extension</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">node</span><span class="w"> </span><span class="p">})</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="nb">None</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">plan_err</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;Can&#39;t cast logical extension &quot;</span><span class="p">),</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">try_encode</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span>
<span class="w">        </span><span class="n">node</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">datafusion</span><span class="p">::</span><span class="n">logical_expr</span><span class="p">::</span><span class="n">Extension</span><span class="p">,</span>
<span class="w">        </span><span class="n">buf</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">datafusion</span><span class="p">::</span><span class="n">error</span><span class="p">::</span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">Sample</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">seed</span><span class="p">,</span><span class="w"> </span><span class="n">fraction</span><span class="p">,</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="p">})</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">node</span><span class="p">.</span><span class="n">node</span><span class="p">.</span><span class="n">as_any</span><span class="p">().</span><span class="n">downcast_ref</span><span class="p">::</span><span class="o">&lt;</span><span class="n">Sample</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">sample</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LSample</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">seed</span><span class="p">:</span><span class="w"> </span><span class="o">*</span><span class="n">seed</span><span class="p">,</span>
<span class="w">                </span><span class="n">fraction</span><span class="p">:</span><span class="w"> </span><span class="o">*</span><span class="n">fraction</span><span class="p">,</span>
<span class="w">            </span><span class="p">};</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LMessage</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">extension</span><span class="p">:</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="k">super</span><span class="p">::</span><span class="n">messages</span><span class="p">::</span><span class="n">l_message</span><span class="p">::</span><span class="n">Extension</span><span class="p">::</span><span class="n">Sample</span><span class="p">(</span><span class="n">sample</span><span class="p">)),</span>
<span class="w">            </span><span class="p">};</span>

<span class="w">            </span><span class="n">message</span>
<span class="w">                </span><span class="p">.</span><span class="n">encode</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="n">map_err</span><span class="p">(</span><span class="o">|</span><span class="n">e</span><span class="o">|</span><span class="w"> </span><span class="n">DataFusionError</span><span class="p">::</span><span class="n">Internal</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">to_string</span><span class="p">()))</span><span class="o">?</span><span class="p">;</span>

<span class="w">            </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="bp">self</span><span class="p">.</span><span class="n">inner</span><span class="p">.</span><span class="n">try_encode</span><span class="p">(</span><span class="n">node</span><span class="p">,</span><span class="w"> </span><span class="n">buf</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="c1">// Additional implementation omitted for brevity</span>
<span class="p">}</span>
</pre></div>
</div>
<p>in short,implementation of the <code class="docutils literal notranslate"><span class="pre">LogicalExtensionCodec</span></code> trait, which handles conversion between Rust structures and
protocol buffer definitions.</p>
</section>
<section id="logical-to-physical-plan-translation">
<h2>Logical to Physical Plan Translation<a class="headerlink" href="#logical-to-physical-plan-translation" title="Link to this heading">¶</a></h2>
<p>Once the logical plan extension is provided, a translation from the logical node to a physical node is required. The
transformation is performed using implementing <code class="docutils literal notranslate"><span class="pre">ExtensionPlanner</span></code> trait:</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="cp">#[derive(Debug, Clone, Default)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">CustomPlannerExtension</span><span class="w"> </span><span class="p">{}</span>

<span class="cp">#[async_trait]</span>
<span class="k">impl</span><span class="w"> </span><span class="n">ExtensionPlanner</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">CustomPlannerExtension</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">plan_extension</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span>
<span class="w">        </span><span class="n">_planner</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">dyn</span><span class="w"> </span><span class="n">PhysicalPlanner</span><span class="p">,</span>
<span class="w">        </span><span class="n">node</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">dyn</span><span class="w"> </span><span class="n">UserDefinedLogicalNode</span><span class="p">,</span>
<span class="w">        </span><span class="n">_logical_inputs</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="p">[</span><span class="o">&amp;</span><span class="n">LogicalPlan</span><span class="p">],</span>
<span class="w">        </span><span class="n">physical_inputs</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="p">[</span><span class="n">Arc</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">ExecutionPlan</span><span class="o">&gt;</span><span class="p">],</span>
<span class="w">        </span><span class="n">_session_state</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">SessionState</span><span class="p">,</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">datafusion</span><span class="p">::</span><span class="n">error</span><span class="p">::</span><span class="nb">Result</span><span class="o">&lt;</span><span class="nb">Option</span><span class="o">&lt;</span><span class="n">Arc</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">ExecutionPlan</span><span class="o">&gt;&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">Sample</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">fraction</span><span class="p">,</span><span class="w"> </span><span class="n">seed</span><span class="p">,</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="p">})</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">node</span><span class="p">.</span><span class="n">as_any</span><span class="p">().</span><span class="n">downcast_ref</span><span class="p">::</span><span class="o">&lt;</span><span class="n">Sample</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">input</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">physical_inputs</span>
<span class="w">                </span><span class="p">.</span><span class="n">first</span><span class="p">()</span>
<span class="w">                </span><span class="p">.</span><span class="n">ok_or</span><span class="p">(</span><span class="n">DataFusionError</span><span class="p">::</span><span class="n">Plan</span><span class="p">(</span><span class="s">&quot;expected single input&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">()))</span><span class="o">?</span>
<span class="w">                </span><span class="p">.</span><span class="n">clone</span><span class="p">();</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">node</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SampleExec</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="o">*</span><span class="n">fraction</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">seed</span><span class="p">,</span><span class="w"> </span><span class="n">input</span><span class="p">);</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">node</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Arc</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="n">node</span><span class="p">);</span>

<span class="w">            </span><span class="nb">Ok</span><span class="p">(</span><span class="nb">Some</span><span class="p">(</span><span class="n">node</span><span class="p">))</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nb">Ok</span><span class="p">(</span><span class="nb">None</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The custom planner is registered in the session state as follows:</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="kd">let</span><span class="w"> </span><span class="n">query_planner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Arc</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="n">QueryPlannerWithExtensions</span><span class="p">::</span><span class="n">default</span><span class="w"> </span><span class="p">());</span>

<span class="kd">let</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SessionStateBuilder</span><span class="p">::</span><span class="n">new</span><span class="p">()</span>
<span class="p">.</span><span class="n">with_query_planner</span><span class="p">(</span><span class="n">query_planner</span><span class="p">)</span>
<span class="p">.</span><span class="n">with_default_features</span><span class="p">()</span>
<span class="p">.</span><span class="n">build</span><span class="p">();</span>
</pre></div>
</div>
<p>Finally, the generated physical plan is serialized using the physical plan extension codec and
transmitted to the executor(s). Implementation is an extension of <code class="docutils literal notranslate"><span class="pre">BallistaPhysicalExtensionCodec</span></code>:</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="cp">#[derive(Debug, Default)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">ExtendedBallistaPhysicalCodec</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">inner</span><span class="p">:</span><span class="w"> </span><span class="nc">BallistaPhysicalExtensionCodec</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">impl</span><span class="w"> </span><span class="n">PhysicalExtensionCodec</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">ExtendedBallistaPhysicalCodec</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">try_decode</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span>
<span class="w">        </span><span class="n">buf</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="p">[</span><span class="kt">u8</span><span class="p">],</span>
<span class="w">        </span><span class="n">inputs</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="p">[</span><span class="n">std</span><span class="p">::</span><span class="n">sync</span><span class="p">::</span><span class="n">Arc</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">datafusion</span><span class="p">::</span><span class="n">physical_plan</span><span class="p">::</span><span class="n">ExecutionPlan</span><span class="o">&gt;</span><span class="p">],</span>
<span class="w">        </span><span class="n">registry</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">dyn</span><span class="w"> </span><span class="n">datafusion</span><span class="p">::</span><span class="n">execution</span><span class="p">::</span><span class="n">FunctionRegistry</span><span class="p">,</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">datafusion</span><span class="p">::</span><span class="n">error</span><span class="p">::</span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">std</span><span class="p">::</span><span class="n">sync</span><span class="p">::</span><span class="n">Arc</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">datafusion</span><span class="p">::</span><span class="n">physical_plan</span><span class="p">::</span><span class="n">ExecutionPlan</span><span class="o">&gt;&gt;</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="o">=</span>
<span class="w">            </span><span class="n">PMessage</span><span class="p">::</span><span class="n">decode</span><span class="p">(</span><span class="n">buf</span><span class="p">).</span><span class="n">map_err</span><span class="p">(</span><span class="o">|</span><span class="n">e</span><span class="o">|</span><span class="w"> </span><span class="n">DataFusionError</span><span class="p">::</span><span class="n">Internal</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">to_string</span><span class="p">()))</span><span class="o">?</span><span class="p">;</span>

<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">message</span><span class="p">.</span><span class="n">extension</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nb">Some</span><span class="p">(</span><span class="k">super</span><span class="p">::</span><span class="n">messages</span><span class="p">::</span><span class="n">p_message</span><span class="p">::</span><span class="n">Extension</span><span class="p">::</span><span class="n">Sample</span><span class="p">(</span><span class="n">PSample</span><span class="w"> </span><span class="p">{</span>
<span class="w">                                                                   </span><span class="n">fraction</span><span class="p">,</span><span class="w"> </span><span class="n">seed</span><span class="p">,</span><span class="w"> </span><span class="o">..</span>
<span class="w">                                                               </span><span class="p">}))</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="kd">let</span><span class="w"> </span><span class="n">input</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">inputs</span>
<span class="w">                    </span><span class="p">.</span><span class="n">first</span><span class="p">()</span>
<span class="w">                    </span><span class="p">.</span><span class="n">ok_or</span><span class="p">(</span><span class="n">DataFusionError</span><span class="p">::</span><span class="n">Plan</span><span class="p">(</span><span class="s">&quot;expected input&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">()))</span><span class="o">?</span>
<span class="w">                    </span><span class="p">.</span><span class="n">clone</span><span class="p">();</span>

<span class="w">                </span><span class="kd">let</span><span class="w"> </span><span class="n">node</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Arc</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="n">SampleExec</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="n">fraction</span><span class="p">,</span><span class="w"> </span><span class="n">seed</span><span class="p">,</span><span class="w"> </span><span class="n">input</span><span class="p">));</span>

<span class="w">                </span><span class="nb">Ok</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="nb">Some</span><span class="p">(</span><span class="k">super</span><span class="p">::</span><span class="n">messages</span><span class="p">::</span><span class="n">p_message</span><span class="p">::</span><span class="n">Extension</span><span class="p">::</span><span class="n">Opaque</span><span class="p">(</span><span class="n">opaque</span><span class="p">))</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="bp">self</span><span class="p">.</span><span class="n">inner</span><span class="p">.</span><span class="n">try_decode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">opaque</span><span class="p">,</span><span class="w"> </span><span class="n">inputs</span><span class="p">,</span><span class="w"> </span><span class="n">registry</span><span class="p">)</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="nb">None</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">plan_err</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;Can&#39;t cast physical extension &quot;</span><span class="p">),</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">try_encode</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span>
<span class="w">        </span><span class="n">node</span><span class="p">:</span><span class="w"> </span><span class="nc">std</span><span class="p">::</span><span class="n">sync</span><span class="p">::</span><span class="n">Arc</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">datafusion</span><span class="p">::</span><span class="n">physical_plan</span><span class="p">::</span><span class="n">ExecutionPlan</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">        </span><span class="n">buf</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">datafusion</span><span class="p">::</span><span class="n">error</span><span class="p">::</span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">SampleExec</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">fraction</span><span class="p">,</span><span class="w"> </span><span class="n">seed</span><span class="p">,</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="p">})</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">node</span><span class="p">.</span><span class="n">as_any</span><span class="p">().</span><span class="n">downcast_ref</span><span class="p">::</span><span class="o">&lt;</span><span class="n">SampleExec</span><span class="o">&gt;</span><span class="p">()</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PMessage</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">extension</span><span class="p">:</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="k">super</span><span class="p">::</span><span class="n">messages</span><span class="p">::</span><span class="n">p_message</span><span class="p">::</span><span class="n">Extension</span><span class="p">::</span><span class="n">Sample</span><span class="p">(</span><span class="n">PSample</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">fraction</span><span class="p">:</span><span class="w"> </span><span class="o">*</span><span class="n">fraction</span><span class="p">,</span>
<span class="w">                    </span><span class="n">seed</span><span class="p">:</span><span class="w"> </span><span class="o">*</span><span class="n">seed</span><span class="p">,</span>
<span class="w">                </span><span class="p">})),</span>
<span class="w">            </span><span class="p">};</span>

<span class="w">            </span><span class="n">message</span>
<span class="w">                </span><span class="p">.</span><span class="n">encode</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="n">map_err</span><span class="p">(</span><span class="o">|</span><span class="n">e</span><span class="o">|</span><span class="w"> </span><span class="n">DataFusionError</span><span class="p">::</span><span class="n">Internal</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">to_string</span><span class="p">()))</span><span class="o">?</span><span class="p">;</span>

<span class="w">            </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">opaque</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[];</span>
<span class="w">            </span><span class="bp">self</span><span class="p">.</span><span class="n">inner</span>
<span class="w">                </span><span class="p">.</span><span class="n">try_encode</span><span class="p">(</span><span class="n">node</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">opaque</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="n">map_err</span><span class="p">(</span><span class="o">|</span><span class="n">e</span><span class="o">|</span><span class="w"> </span><span class="n">DataFusionError</span><span class="p">::</span><span class="n">Internal</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">to_string</span><span class="p">()))</span><span class="o">?</span><span class="p">;</span>

<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PMessage</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">extension</span><span class="p">:</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="k">super</span><span class="p">::</span><span class="n">messages</span><span class="p">::</span><span class="n">p_message</span><span class="p">::</span><span class="n">Extension</span><span class="p">::</span><span class="n">Opaque</span><span class="p">(</span><span class="n">opaque</span><span class="p">)),</span>
<span class="w">            </span><span class="p">};</span>

<span class="w">            </span><span class="n">message</span>
<span class="w">                </span><span class="p">.</span><span class="n">encode</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="n">map_err</span><span class="p">(</span><span class="o">|</span><span class="n">e</span><span class="o">|</span><span class="w"> </span><span class="n">DataFusionError</span><span class="p">::</span><span class="n">Internal</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">to_string</span><span class="p">()))</span><span class="o">?</span><span class="p">;</span>

<span class="w">            </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This should be all moving parts necessary to extend ballista functionality. Last step would be to
configure scheduler and executor to use new features.</p>
<p><code class="docutils literal notranslate"><span class="pre">SchedulerConfig</span></code> should be configured overriding logical, physical codec and session builder function:</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="kd">let</span><span class="w"> </span><span class="n">config</span><span class="p">:</span><span class="w"> </span><span class="nc">SchedulerConfig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SchedulerConfig</span><span class="w"> </span><span class="p">{</span>
<span class="n">override_logical_codec</span><span class="p">:</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">Arc</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="n">ExtendedBallistaLogicalCodec</span><span class="p">::</span><span class="n">default</span><span class="w"> </span><span class="p">())),</span>
<span class="n">override_physical_codec</span><span class="p">:</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">Arc</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="n">ExtendedBallistaPhysicalCodec</span><span class="p">::</span><span class="n">default</span><span class="w"> </span><span class="p">())),</span>
<span class="n">override_session_builder</span><span class="p">:</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">Arc</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="n">extended_state_producer</span><span class="p">)),</span>
<span class="o">..</span><span class="nb">Default</span><span class="p">::</span><span class="n">default</span><span class="w"> </span><span class="p">()</span>
<span class="p">};</span>

<span class="kd">let</span><span class="w"> </span><span class="n">address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">format!</span><span class="p">(</span><span class="s">&quot;{}:{}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">config</span><span class="p">.</span><span class="n">bind_host</span><span class="p">,</span><span class="w"> </span><span class="n">config</span><span class="p">.</span><span class="n">bind_port</span><span class="p">);</span>
<span class="kd">let</span><span class="w"> </span><span class="n">address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">address</span>
<span class="p">.</span><span class="n">parse</span><span class="p">()</span>
<span class="p">.</span><span class="n">map_err</span><span class="p">(</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">e</span><span class="p">:</span><span class="w"> </span><span class="nc">AddrParseError</span><span class="o">|</span><span class="w"> </span><span class="n">BallistaError</span><span class="p">::</span><span class="n">Configuration</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">to_string</span><span class="p">()))</span><span class="w"> </span><span class="o">?</span><span class="p">;</span>

<span class="kd">let</span><span class="w"> </span><span class="n">cluster</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BallistaCluster</span><span class="p">::</span><span class="n">new_from_config</span><span class="p">(</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">config</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>

<span class="n">start_server</span><span class="p">(</span><span class="n">cluster</span><span class="p">,</span><span class="w"> </span><span class="n">address</span><span class="p">,</span><span class="w"> </span><span class="n">Arc</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="n">config</span><span class="p">)).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">extended_state_producer</span><span class="p">(</span><span class="n">config</span><span class="p">:</span><span class="w"> </span><span class="nc">SessionConfig</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">datafusion</span><span class="p">::</span><span class="n">error</span><span class="p">::</span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">SessionState</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// we need custom query planner to convert logical to physical operator</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">query_planner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Arc</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="n">QueryPlannerWithExtensions</span><span class="p">::</span><span class="n">default</span><span class="p">());</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SessionStateBuilder</span><span class="p">::</span><span class="n">new</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="n">with_config</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="n">with_query_planner</span><span class="p">(</span><span class="n">query_planner</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="n">with_default_features</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="n">build</span><span class="p">();</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
<p>similarly for <code class="docutils literal notranslate"><span class="pre">ExecutorProcessConfig</span></code>:</p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="kd">let</span><span class="w"> </span><span class="n">config</span><span class="p">:</span><span class="w"> </span><span class="nc">ExecutorProcessConfig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ExecutorProcessConfig</span><span class="w"> </span><span class="p">{</span>
<span class="n">override_logical_codec</span><span class="p">:</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">Arc</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="n">ExtendedBallistaLogicalCodec</span><span class="p">::</span><span class="n">default</span><span class="w"> </span><span class="p">())),</span>
<span class="n">override_physical_codec</span><span class="p">:</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">Arc</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="n">ExtendedBallistaPhysicalCodec</span><span class="p">::</span><span class="n">default</span><span class="w"> </span><span class="p">())),</span>
<span class="o">..</span><span class="nb">Default</span><span class="p">::</span><span class="n">default</span><span class="w"> </span><span class="p">()</span>
<span class="p">};</span>

<span class="n">start_executor_process</span><span class="p">(</span><span class="n">Arc</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="n">config</span><span class="p">)).</span><span class="k">await</span>
</pre></div>
</div>
</section>
<section id="conclusion">
<h2>Conclusion<a class="headerlink" href="#conclusion" title="Link to this heading">¶</a></h2>
<p>This project demonstrates how to extend Ballista with custom logical and physical operators, codecs, and planner logic.
By following the outlined steps, you can introduce new DataFrame operations and ensure they are supported throughout the
distributed query lifecycle.</p>
<p>For more details, refer to the source code and the linked example files. Contributions and feedback are welcome!</p>
<hr class="docutils" />
<p><strong>Related links:</strong></p>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/milenkovicm/ballista_extensions">Ballista Extensions Source Code</a></p></li>
<li><p><a class="reference external" href="https://datafusion.apache.org">DataFusion Documentation</a></p></li>
<li><p><a class="reference external" href="https://docs.rs/tonic/latest/tonic/">Rust Tonic (GRPC) support</a></p></li>
</ul>
</section>
</section>


              </div>
              
              
              <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="extending-components.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Extending Ballista Scheduler And Executors</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="../contributors-guide/architecture.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Ballista Architecture</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
              
          </main>
          

      </div>
    </div>
  
    <script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>
  
<!-- Based on pydata_sphinx_theme/footer.html -->
<footer class="footer mt-5 mt-md-0">
  <div class="container">
    
    <div class="footer-item">
      <p class="copyright">
    &copy; Copyright 2019-2024, Apache Software Foundation.<br>
</p>
    </div>
    
    <div class="footer-item">
      <p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 8.1.3.<br>
</p>
    </div>
    
    <div class="footer-item">
      <p>Apache DataFusion Ballista, Arrow Ballista, Apache, the Apache feather logo, and the Apache DataFusion Ballista project logo</p>
      <p>are either registered trademarks or trademarks of The Apache Software Foundation in the United States and other countries.</p>
    </div>
  </div>
</footer>


  </body>
</html>